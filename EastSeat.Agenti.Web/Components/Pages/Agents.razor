@page "/agents"
@using Microsoft.AspNetCore.Authorization
@using EastSeat.Agenti.Web.Features.Agents
@attribute [Authorize]
@rendermode InteractiveServer
@inject IAgentService AgentService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Agents - Agenti</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudGrid>
        <MudItem xs="12" sm="8">
            <MudText Typo="Typo.h4" Class="mb-2">ðŸ‘¥ Agents</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Manage agents and their wallet configurations
            </MudText>
        </MudItem>
        <MudItem xs="12" sm="4" Class="d-flex justify-end align-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                OnClick="OpenCreateDialog">
                Add Agent
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_isLoading)
    {
        <MudGrid Class="mt-4">
            <MudItem xs="12" Class="d-flex justify-center">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </MudItem>
        </MudGrid>
    }
    else if (_agents.Count == 0)
    {
        <MudGrid Class="mt-4">
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                    <MudText Typo="Typo.body1">No agents configured yet.</MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        Click "Add Agent" to create your first agent.
                    </MudText>
                </MudAlert>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudGrid Class="mt-4">
            <MudItem xs="12">
                <MudTable Items="@_agents" Hover="true" Striped="true" Dense="true" Elevation="2">
                    <HeaderContent>
                        <MudTh>Code</MudTh>
                        <MudTh>Name</MudTh>
                        <MudTh>Contact</MudTh>
                        <MudTh Style="text-align: center;">Wallets</MudTh>
                        <MudTh Style="text-align: right;">Total Balance</MudTh>
                        <MudTh Style="text-align: center;">Status</MudTh>
                        <MudTh Style="text-align: center;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Code">
                            <MudText Typo="Typo.body2"><strong>@context.Code</strong></MudText>
                        </MudTd>
                        <MudTd DataLabel="Name">@context.FullName</MudTd>
                        <MudTd DataLabel="Contact">
                            @if (!string.IsNullOrEmpty(context.Email))
                            {
                                <MudText Typo="Typo.caption">@context.Email</MudText>
                            }
                            @if (!string.IsNullOrEmpty(context.PhoneNumber))
                            {
                                <MudText Typo="Typo.caption">@context.PhoneNumber</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Wallets" Style="text-align: center;">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                @context.WalletCount
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Total Balance" Style="text-align: right;">
                            <MudText Typo="Typo.body2">
                                UGX @context.TotalBalance.ToString("N0")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Status" Style="text-align: center;">
                            <MudChip T="string" Size="Size.Small" Color="@(context.IsActive? Color.Success: Color.Default)">
                                @(context.IsActive ? "Active" : "Inactive")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align: center;">
                            <MudButtonGroup Size="Size.Small" Variant="Variant.Text">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary"
                                    OnClick="@(() => ViewAgent(context.Id))" Title="View Details" />
                                <MudIconButton Icon="@Icons.Material.Filled.Wallet" Color="Color.Info"
                                    OnClick="@(() => OpenWalletDialog(context))" Title="Manage Wallets" />
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default"
                                    OnClick="@(() => OpenEditDialog(context))" Title="Edit" />
                                <MudIconButton
                                    Icon="@(context.IsActive? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)"
                                    Color="@(context.IsActive? Color.Warning: Color.Success)"
                                    OnClick="@(() => ToggleStatus(context))"
                                    Title="@(context.IsActive ? "Deactivate" : "Activate")" />
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<!-- Agent Form Dialog -->
@if (_showAgentDialog)
{
    <MudOverlay Visible="true" DarkBackground="true" ZIndex="9999" OnClick="CloseAgentDialog" />
    <MudPaper Class="pa-4"
        Style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; width: 500px; max-width: 90vw;">
        <MudText Typo="Typo.h6" Class="mb-4">@(_agentForm.Id.HasValue ? "Edit Agent" : "Add Agent")</MudText>

        @if (_isLoadingUsers)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </div>
        }
        else
        {
            <MudGrid>
                @if (!_agentForm.Id.HasValue)
                {
                    <MudItem xs="12">
                        <MudSelect T="string" @bind-Value="_agentForm.UserId" Label="Select User" Variant="Variant.Outlined"
                            Required="true" RequiredError="User is required" AnchorOrigin="Origin.BottomCenter">
                            @if (_availableUsers.Count == 0)
                            {
                                <MudSelectItem T="string" Value="@string.Empty" Disabled="true">
                                    No available users
                                </MudSelectItem>
                            }
                            else
                            {
                                @foreach (var user in _availableUsers)
                                {
                                    <MudSelectItem T="string" Value="@user.Id">@user.DisplayName</MudSelectItem>
                                }
                            }
                        </MudSelect>
                        @if (_availableUsers.Count == 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Warning" Class="mt-1">
                                All registered users are already linked to agents. Register new users first.
                            </MudText>
                        }
                        else if (!string.IsNullOrEmpty(_agentForm.UserId))
                        {
                            var selectedUser = _availableUsers.FirstOrDefault(u => u.Id == _agentForm.UserId);
                            if (selectedUser != null)
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-2">
                                    <MudText Typo="Typo.caption"><strong>Name:</strong> @selectedUser.FullName</MudText>
                                    <MudText Typo="Typo.caption"><strong>Email:</strong> @selectedUser.Email</MudText>
                                    @if (!string.IsNullOrEmpty(selectedUser.PhoneNumber))
                                    {
                                        <MudText Typo="Typo.caption"><strong>Phone:</strong> @selectedUser.PhoneNumber</MudText>
                                    }
                                    <MudText Typo="Typo.caption"><strong>Agent Code:</strong> @GenerateCodePreview(selectedUser)
                                        (auto-generated)</MudText>
                                </MudAlert>
                            }
                        }
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true">
                            <MudText Typo="Typo.caption">Agent profile (name, email, phone) is managed through the linked user
                                account.</MudText>
                        </MudAlert>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_agentForm.Code" Label="Agent Code" Variant="Variant.Outlined" Required="true"
                            RequiredError="Code is required" />
                    </MudItem>
                }
                <MudItem xs="12" sm="6">
                    <MudSelect T="long?" @bind-Value="_agentForm.BranchId" Label="Branch" Variant="Variant.Outlined"
                        AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="long?" Value="@(null as long?)">-- Select Branch --</MudSelectItem>
                        @foreach (var branch in _branches)
                        {
                            <MudSelectItem T="long?" Value="@branch.Id">@branch.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="_agentForm.IsActive" Label="Active" Color="Color.Success" />
                </MudItem>
            </MudGrid>
            <div class="d-flex justify-end gap-2 mt-4">
                <MudButton OnClick="CloseAgentDialog" Color="Color.Default">Cancel</MudButton>
                <MudButton OnClick="SaveAgent" Color="Color.Primary" Variant="Variant.Filled"
                    Disabled="@(_isSaving || (!_agentForm.Id.HasValue && _availableUsers.Count == 0))">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Save
                </MudButton>
            </div>
        }
    </MudPaper>
}

<!-- Wallet Management Dialog -->
@if (_showWalletDialog)
{
    <MudOverlay Visible="true" DarkBackground="true" ZIndex="9999" OnClick="CloseWalletDialog" />
    <MudPaper Class="pa-4"
        Style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; width: 600px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
        <MudText Typo="Typo.h6" Class="mb-4">ðŸ’¼ Wallets for @_selectedAgent?.FullName (@_selectedAgent?.Code)</MudText>

        @if (_isLoadingWallets)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </div>
        }
        else
        {
            @if (_agentWallets.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mb-4">
                    No wallets configured for this agent yet.
                </MudAlert>
            }
            else
            {
                <MudTable Items="@_agentWallets" Hover="true" Dense="true" Elevation="0" Class="mb-4">
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh Style="text-align: right;">Balance</MudTh>
                        <MudTh Style="text-align: center;">Status</MudTh>
                        <MudTh Style="text-align: center;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">
                            <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            @context.WalletTypeIcon @context.WalletTypeName
                        </MudTd>
                        <MudTd DataLabel="Balance" Style="text-align: right;">
                            <MudText Typo="Typo.body2" Color="@(context.Balance > 0 ? Color.Success : Color.Default)">
                                @context.Currency @context.Balance.ToString("N0")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Status" Style="text-align: center;">
                            <MudChip T="string" Size="Size.Small" Color="@(context.IsActive? Color.Success: Color.Default)">
                                @(context.IsActive ? "Active" : "Inactive")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align: center;">
                            <MudButtonGroup Size="Size.Small" Variant="Variant.Text">
                                <MudIconButton
                                    Icon="@(context.IsActive? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)"
                                    Color="@(context.IsActive? Color.Warning: Color.Success)"
                                    OnClick="@(() => ToggleWalletStatus(context))"
                                    Title="@(context.IsActive ? "Deactivate" : "Activate")" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                    Disabled="@(context.Balance != 0)" OnClick="@(() => DeleteWallet(context))"
                                    Title="@(context.Balance != 0 ? "Cannot delete: balance is not zero" : "Delete")" />
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }

            <MudDivider Class="my-4" />

            @if (_availableWalletTypes.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true">
                    All available wallet types have been added to this agent.
                </MudAlert>
            }
            else
            {
                <MudText Typo="Typo.subtitle1" Class="mb-2">Add Wallet</MudText>
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="long" @bind-Value="_walletForm.WalletTypeId" Label="Wallet Type" Variant="Variant.Outlined"
                            AnchorOrigin="Origin.BottomCenter">
                            @foreach (var wt in _availableWalletTypes)
                            {
                                <MudSelectItem T="long" Value="@wt.Id">@GetWalletTypeIcon(wt.Type) @wt.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_walletForm.Name" Label="Wallet Name" Variant="Variant.Outlined"
                            Placeholder="e.g., Main Cash Drawer" Required="true" />
                    </MudItem>
                    <MudItem xs="12" Class="d-flex justify-end">
                        <MudButton OnClick="AddWallet" Color="Color.Primary" Variant="Variant.Filled"
                            Disabled="@(_isSavingWallet || _walletForm.WalletTypeId == 0 || string.IsNullOrWhiteSpace(_walletForm.Name))"
                            StartIcon="@Icons.Material.Filled.Add">
                            @if (_isSavingWallet)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Add Wallet
                        </MudButton>
                    </MudItem>
                </MudGrid>
            }
        }

        <div class="d-flex justify-end mt-4">
            <MudButton OnClick="CloseWalletDialog" Color="Color.Default">Close</MudButton>
        </div>
    </MudPaper>
}

@code {
    private List<AgentListItemDto> _agents = [];
    private List<AvailableUserDto> _availableUsers = [];
    private List<BranchDto> _branches = [];
    private bool _isLoading = true;
    private bool _isLoadingUsers = false;
    private bool _isSaving = false;
    private bool _showAgentDialog = false;
    private AgentFormModel _agentForm = new();

    // Wallet dialog state
    private bool _showWalletDialog = false;
    private bool _isLoadingWallets = false;
    private bool _isSavingWallet = false;
    private AgentListItemDto? _selectedAgent;
    private List<AgentWalletDto> _agentWallets = [];
    private List<WalletTypeDto> _availableWalletTypes = [];
    private WalletFormModel _walletForm = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAgentsAsync();
    }

    private async Task LoadAgentsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _agents = await AgentService.GetAgentsAsync();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ViewAgent(long agentId)
    {
        NavigationManager.NavigateTo($"/agents/{agentId}");
    }

    private async Task OpenCreateDialog()
    {
        _agentForm = new AgentFormModel { IsActive = true };
        _showAgentDialog = true;
        _isLoadingUsers = true;
        StateHasChanged();

        try
        {
            var users = await AgentService.GetAvailableUsersAsync();
            var branches = await AgentService.GetBranchesAsync();
            _availableUsers = users;
            _branches = branches;
        }
        finally
        {
            _isLoadingUsers = false;
            StateHasChanged();
        }
    }

    private async Task OpenEditDialog(AgentListItemDto agent)
    {
        _showAgentDialog = true;

        try
        {
            // Load agent details including BranchId
            var agentDetail = await AgentService.GetAgentAsync(agent.Id);
            if (agentDetail != null)
            {
                _agentForm = new AgentFormModel
                {
                    Id = agent.Id,
                    Code = agent.Code,
                    BranchId = agentDetail.BranchId,
                    IsActive = agent.IsActive
                };
            }
            else
            {
                _agentForm = new AgentFormModel
                {
                    Id = agent.Id,
                    Code = agent.Code,
                    IsActive = agent.IsActive
                };
            }

            var branches = await AgentService.GetBranchesAsync();
            _branches = branches;
            _availableUsers = []; // Not needed for edit
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load agent details: {ex.Message}", Severity.Error);
        }
    }

    private void CloseAgentDialog()
    {
        _showAgentDialog = false;
        _agentForm = new();
        _availableUsers = [];
    }

    private async Task SaveAgent()
    {
        // Validation for new agents - only need to select a user (code is auto-generated)
        if (!_agentForm.Id.HasValue && string.IsNullOrEmpty(_agentForm.UserId))
        {
            Snackbar.Add("Please select a user.", Severity.Warning);
            return;
        }

        // Validation for editing - code is required
        if (_agentForm.Id.HasValue && string.IsNullOrWhiteSpace(_agentForm.Code))
        {
            Snackbar.Add("Please enter an agent code.", Severity.Warning);
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            var result = _agentForm.Id.HasValue
            ? await AgentService.UpdateAgentAsync(_agentForm)
            : await AgentService.CreateAgentAsync(_agentForm);

            if (result.Success)
            {
                Snackbar.Add(_agentForm.Id.HasValue ? "Agent updated successfully." : "Agent created successfully.", Severity.Success);
                CloseAgentDialog();
                await LoadAgentsAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to save agent.", Severity.Error);
            }
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Generates a preview of the agent code from the user's name.
    /// Format: First 2 letters of FirstName + First 2 letters of LastName (uppercase)
    /// </summary>
    private static string GenerateCodePreview(AvailableUserDto user)
    {
        var cleanFirst = new string(user.FirstName.Where(char.IsLetter).ToArray()).ToUpperInvariant();
        var cleanLast = new string(user.LastName.Where(char.IsLetter).ToArray()).ToUpperInvariant();

        var firstPart = cleanFirst.Length >= 2 ? cleanFirst[..2] : cleanFirst.PadRight(2, 'X');
        var lastPart = cleanLast.Length >= 2 ? cleanLast[..2] : cleanLast.PadRight(2, 'X');

        return firstPart + lastPart;
    }

    private async Task ToggleStatus(AgentListItemDto agent)
    {
        var result = await AgentService.ToggleAgentStatusAsync(agent.Id);
        if (result.Success)
        {
            Snackbar.Add($"Agent {(agent.IsActive ? "deactivated" : "activated")}.", Severity.Success);
            await LoadAgentsAsync();
        }
        else
        {
            Snackbar.Add(result.ErrorMessage ?? "Failed to update status.", Severity.Error);
        }
    }

    // Wallet dialog methods
    private async Task OpenWalletDialog(AgentListItemDto agent)
    {
        _selectedAgent = agent;
        _walletForm = new WalletFormModel { AgentId = agent.Id, IsActive = true };
        _showWalletDialog = true;
        _isLoadingWallets = true;
        StateHasChanged();

        try
        {
            _agentWallets = await AgentService.GetAgentWalletsAsync(agent.Id);
            _availableWalletTypes = await AgentService.GetAvailableWalletTypesForAgentAsync(agent.Id);
        }
        finally
        {
            _isLoadingWallets = false;
            StateHasChanged();
        }
    }

    private void CloseWalletDialog()
    {
        _showWalletDialog = false;
        _selectedAgent = null;
        _agentWallets = [];
        _availableWalletTypes = [];
        _walletForm = new();
    }

    private async Task AddWallet()
    {
        if (_walletForm.WalletTypeId == 0 || string.IsNullOrWhiteSpace(_walletForm.Name))
        {
            Snackbar.Add("Please select a wallet type and enter a name.", Severity.Warning);
            return;
        }

        _isSavingWallet = true;
        StateHasChanged();

        try
        {
            var result = await AgentService.AddWalletAsync(_walletForm);
            if (result.Success)
            {
                Snackbar.Add("Wallet added successfully.", Severity.Success);
                _walletForm = new WalletFormModel { AgentId = _selectedAgent!.Id, IsActive = true };
                _agentWallets = await AgentService.GetAgentWalletsAsync(_selectedAgent.Id);
                _availableWalletTypes = await AgentService.GetAvailableWalletTypesForAgentAsync(_selectedAgent.Id);
                await LoadAgentsAsync(); // Refresh the main list
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to add wallet.", Severity.Error);
            }
        }
        finally
        {
            _isSavingWallet = false;
            StateHasChanged();
        }
    }

    private async Task ToggleWalletStatus(AgentWalletDto wallet)
    {
        var result = await AgentService.ToggleWalletStatusAsync(wallet.Id);
        if (result.Success)
        {
            Snackbar.Add($"Wallet {(wallet.IsActive ? "deactivated" : "activated")}.", Severity.Success);
            _agentWallets = await AgentService.GetAgentWalletsAsync(_selectedAgent!.Id);
            await LoadAgentsAsync();
        }
        else
        {
            Snackbar.Add(result.ErrorMessage ?? "Failed to update wallet status.", Severity.Error);
        }
    }

    private async Task DeleteWallet(AgentWalletDto wallet)
    {
        if (wallet.Balance != 0)
        {
            Snackbar.Add("Cannot delete wallet with non-zero balance.", Severity.Warning);
            return;
        }

        var confirmed = await DialogService.ShowMessageBox(
                            "Delete Wallet",
        $"Are you sure you want to delete '{wallet.Name}'? This action cannot be undone.",
        yesText: "Delete", cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await AgentService.DeleteWalletAsync(wallet.Id);
            if (result.Success)
            {
                Snackbar.Add("Wallet deleted successfully.", Severity.Success);
                _agentWallets = await AgentService.GetAgentWalletsAsync(_selectedAgent!.Id);
                _availableWalletTypes = await AgentService.GetAvailableWalletTypesForAgentAsync(_selectedAgent.Id);
                await LoadAgentsAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to delete wallet.", Severity.Error);
            }
        }
    }

    private static string GetWalletTypeIcon(Shared.Domain.Enums.WalletTypeEnum type) => type switch
    {
        Shared.Domain.Enums.WalletTypeEnum.Cash => "ðŸ’µ",
        Shared.Domain.Enums.WalletTypeEnum.MobileMoney => "ðŸ“±",
        Shared.Domain.Enums.WalletTypeEnum.Bank => "ðŸ¦",
        _ => "ðŸ’°"
    };
}